<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ITS Map Module</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"
    />

    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100vh;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script>
      // 1. Khá»Ÿi táº¡o báº£n Ä‘á»“
      var map = L.map("map").setView([10.762622, 106.660172], 13);
      L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap",
      }).addTo(map);

      // --- ICON Cáº¤U HÃŒNH ---
      var carIcon = L.icon({
          iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
          shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
          iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
      });

      // Icon riÃªng cho NgÆ°á»i dÃ¹ng (MÃ u Ä‘á» Ä‘á»ƒ phÃ¢n biá»‡t)
      // ChÃºng ta dÃ¹ng filter hue-rotate Ä‘á»ƒ Ä‘á»•i mÃ u icon máº·c Ä‘á»‹nh sang Ä‘á»
      var userIcon = L.icon({
          iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
          shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
          iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
      });

      // 2. GIáº¢ Láº¬P Vá»Š TRÃ NGÆ¯á»œI DÃ™NG
      var userLat = 10.7721;
      var userLng = 106.6983;
      L.marker([userLat, userLng], {icon: userIcon}).addTo(map)
          .bindPopup("<b>Vá»‹ trÃ­ cá»§a báº¡n</b>").openPopup();

      // Biáº¿n lÆ°u trá»¯ Ä‘Æ°á»ng Ä‘i hiá»‡n táº¡i (Ä‘á»ƒ xÃ³a Ä‘i khi chá»n Ä‘Æ°á»ng má»›i)
      var currentRoute = null;

      // --- HÃ€M Váº¼ ÄÆ¯á»œNG (CORE ITS FEATURE) ---
      function chiDuong(destLat, destLng) {
          // Náº¿u Ä‘Ã£ cÃ³ Ä‘Æ°á»ng váº½ rá»“i thÃ¬ xÃ³a Ä‘i Ä‘á»ƒ váº½ Ä‘Æ°á»ng má»›i
          if (currentRoute) {
              map.removeControl(currentRoute);
          }

          // Gá»i plugin Routing Machine Ä‘á»ƒ váº½ Ä‘Æ°á»ng
          currentRoute = L.Routing.control({
              waypoints: [
                  L.latLng(userLat, userLng), // Äiá»ƒm xuáº¥t phÃ¡t (User)
                  L.latLng(destLat, destLng)  // Äiá»ƒm Ä‘Ã­ch (Xe)
              ],
              routeWhileDragging: false,
              // Táº¯t hÆ°á»›ng dáº«n chi tiáº¿t báº±ng chá»¯
              showAlternatives: false,
              lineOptions: {
                  styles: [{color: 'blue', opacity: 0.6, weight: 6}]
              },
              createMarker: function() { return null; } // KhÃ´ng táº¡o thÃªm marker thá»«a
          }).addTo(map);
      }

      // 3. HIá»‚N THá»Š XE Tá»ª Dá»® LIá»†U
      var vehicles = {{ vehicles_json|safe }};

      vehicles.forEach(function (xe) {
          var marker = L.marker([xe.lat, xe.lng], {icon: carIcon}).addTo(map);

          // Ná»™i dung Popup cÃ³ thÃªm nÃºt "Chá»‰ Ä‘Æ°á»ng"
          var popupContent = `
              <div style="text-align: center;">
                  <h3 style="margin: 0; color: #007bff;">${xe.plate}</h3>
                  <p style="margin: 5px 0;"><b>${xe.name}</b></p>
                  <p>Tráº¡ng thÃ¡i: <b>${xe.status}</b></p>

                  <button onclick="chiDuong(${xe.lat}, ${xe.lng})"
                      style="cursor: pointer; padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 3px; margin-right: 5px;">
                      ğŸš— Chá»‰ Ä‘Æ°á»ng
                  </button>

                  <button onclick="alert('ÄÃ£ gá»­i yÃªu cáº§u Ä‘áº·t xe!')"
                      style="cursor: pointer; padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 3px;">
                      Äáº·t ngay
                  </button>
              </div>
          `;
          marker.bindPopup(popupContent);
      });
    </script>
  </body>
</html>
